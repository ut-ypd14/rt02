<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>異常記錄表</title>
<style>
:root{
  --bg:#0b0f14; --panel:#0f172a; --text:#e5e7eb; --muted:#9ca3af;
  --accent:#22d3ee; --line:#233044;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,"PingFang TC","Microsoft JhengHei",sans-serif}
.container{max-width:760px;margin:6vh auto;padding:0 16px}
.card{background:linear-gradient(180deg,var(--panel),#111827);
  border:1px solid var(--line); border-radius:16px; box-shadow:0 12px 32px rgba(2,6,23,.35)}
.header{padding:22px 18px 8px;text-align:center;border-bottom:1px solid var(--line)}
.title{font-size:22px;font-weight:800;letter-spacing:.12em;color:var(--accent)}
.subtitle{margin-top:6px;color:var(--muted);font-size:12px}

.form{padding:18px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-bottom:12px}
.block{background:#0e1522;border:1px solid var(--line);border-radius:10px;padding:10px}
.block label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
.block input,.block select,.block textarea{
  width:100%;background:#0c1220;border:1px solid #223049;color:var(--text);
  border-radius:8px;padding:10px 12px;font-size:14px}
.block input[readonly]{text-align:center;background:#0b1220;color:#cbd5e1}
.center{text-align:center}

.col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}

/* 軸列：單一大框，串接視覺 */
.axis-stack{border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#0c1220}
.axis-block{padding:12px;border-top:1px solid #1e2a3d}
.axis-block:first-child{border-top:none}
.axis-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.axis-title{font-size:12px;color:var(--muted)}
.axis-fields{display:grid;grid-template-columns:1fr 1fr 140px; gap:8px}
.axis-fields input[type=number]{text-align:right}

/* 收折動畫 */
.collapsed{max-height:0;overflow:hidden;opacity:.0;pointer-events:none;transition:max-height .25s ease,opacity .25s ease}
.expanded{max-height:180px;opacity:1;transition:max-height .25s ease,opacity .25s ease}
.hint{color:var(--muted);font-size:12px;margin-top:6px}

.actions{display:flex;gap:10px;margin-top:8px}
.btn{flex:1;background:var(--accent);color:#001017;border:none;border-radius:10px;padding:12px;font-weight:700;font-size:15px;cursor:pointer}
.btn.secondary{background:#1f2937;color:#cbd5e1;border:1px solid var(--line)}

@media (max-width:640px){
  .axis-fields{grid-template-columns:1fr 1fr 100px}
}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div class="title">異常記錄表</div>
      <div class="subtitle">Abnormal Record Form</div>
    </div>

    <div class="form">
      <!-- 2) 日期 班別 機台 -->
      <div class="row">
        <div class="block col-4">
          <label>日期</label>
          <input id="date_display" readonly class="center" />
        </div>
        <div class="block col-4">
          <label>班別</label>
          <input id="shift_display" readonly class="center" />
        </div>
        <div class="block col-4">
          <label>機台</label>
          <input id="machine_id" placeholder="請輸入機台代號" />
        </div>
      </div>

      <!-- 3) 產品型態 料號 -->
      <div class="row">
        <div class="block col-6">
          <label>產品型態</label>
          <select id="product_type"></select>
        </div>
        <div class="block col-6">
          <label>料號</label>
          <input id="part_no" placeholder="7 碼料號" />
        </div>
      </div>

      <!-- 4) FA 批號 -->
      <div class="row">
        <div class="block col-6">
          <label>FA</label>
          <select id="fa_stage"></select>
        </div>
        <div class="block col-6">
          <label>批號</label>
          <input id="lot_no" placeholder="請輸入批號" />
        </div>
      </div>

      <!-- 5–10) 軸別、類別、數量 ×6（無任何勾選；填齊自動展開下一列） -->
      <div class="row">
        <div class="col-12">
          <div class="axis-stack" id="axisStack">
            <!-- 軸1 可見 -->
            <div class="axis-block expanded" data-idx="1">
              <div class="axis-head">
                <div class="axis-title">軸1</div>
              </div>
              <div class="axis-fields">
                <select id="axis_1"></select>
                <select id="cat_1"></select>
                <input id="qty_1" type="number" min="0" placeholder="數量" />
              </div>
            </div>

            <!-- 軸2~6 預設收折 -->
            <div class="axis-block collapsed" data-idx="2">
              <div class="axis-head"><div class="axis-title">軸2</div></div>
              <div class="axis-fields">
                <select id="axis_2"></select>
                <select id="cat_2"></select>
                <input id="qty_2" type="number" min="0" placeholder="數量" />
              </div>
            </div>

            <div class="axis-block collapsed" data-idx="3">
              <div class="axis-head"><div class="axis-title">軸3</div></div>
              <div class="axis-fields">
                <select id="axis_3"></select>
                <select id="cat_3"></select>
                <input id="qty_3" type="number" min="0" placeholder="數量" />
              </div>
            </div>

            <div class="axis-block collapsed" data-idx="4">
              <div class="axis-head"><div class="axis-title">軸4</div></div>
              <div class="axis-fields">
                <select id="axis_4"></select>
                <select id="cat_4"></select>
                <input id="qty_4" type="number" min="0" placeholder="數量" />
              </div>
            </div>

            <div class="axis-block collapsed" data-idx="5">
              <div class="axis-head"><div class="axis-title">軸5</div></div>
              <div class="axis-fields">
                <select id="axis_5"></select>
                <select id="cat_5"></select>
                <input id="qty_5" type="number" min="0" placeholder="數量" />
              </div>
            </div>

            <div class="axis-block collapsed" data-idx="6">
              <div class="axis-head"><div class="axis-title">軸6</div></div>
              <div class="axis-fields">
                <select id="axis_6"></select>
                <select id="cat_6"></select>
                <input id="qty_6" type="number" min="0" placeholder="數量" />
              </div>
            </div>
          </div>
          <div class="hint">規則：本列三欄皆有效（軸別、類別、數量>0）→ 自動展開下一列；若變為不完整 → 收回後續列。</div>
        </div>
      </div>

      <!-- 11) 切板手  12) 檢驗者 -->
      <div class="row">
        <div class="block col-6">
          <label class="center">切板手</label>
          <input id="cutter_a" class="center" placeholder="切板手代號" />
        </div>
        <div class="block col-6">
          <label class="center">檢驗者</label>
          <input id="inspector" class="center" placeholder="檢驗者代號" />
        </div>
      </div>

      <!-- 14) 重工（移除「需要重工」字樣） -->
      <div class="row">
        <div class="block col-4">
          <label class="center">重工</label>
          <div class="center"><input type="checkbox" id="rework_confirm" /></div>
        </div>
        <div class="block col-8">
          <label>重工者</label>
          <input id="reworker" placeholder="重工者代號" disabled />
        </div>
      </div>

      <!-- 15) 報廢/續留 -->
      <div class="row">
        <div class="block col-6">
          <label class="center">報廢</label>
          <div class="center"><input type="checkbox" id="scrap_yes" /></div>
        </div>
        <div class="block col-6">
          <label class="center">續留</label>
          <div class="center"><input type="checkbox" id="scrap_keep" /></div>
        </div>
      </div>

      <!-- 16) 備註 -->
      <div class="row">
        <div class="block col-12">
          <label>備註</label>
          <textarea id="remark" rows="3" placeholder="填寫補充說明"></textarea>
        </div>
      </div>

      <!-- 17) 複檢員 + 按鈕 -->
      <div class="row">
        <div class="block col-6">
          <label class="center">複檢員</label>
          <input id="reviewer" class="center" placeholder="複檢員代號" />
        </div>
        <div class="block col-6 actions">
          <button class="btn secondary" id="btnPreview">預覽</button>
          <button class="btn" id="btnSubmit">送出</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// === 最小骨架 ===
document.addEventListener('DOMContentLoaded', () => {
  initDateShift();
  initSelectOptions();
  bindAxisAutoProgress();
  bindMutualLocks();
  bindActions();
});

function initDateShift(){
  if (typeof window.config_getDateShift === 'function'){
    const {date, shift} = window.config_getDateShift();
    document.getElementById('date_display').value = date || '';
    document.getElementById('shift_display').value = shift || '';
  }
}

function initSelectOptions(){
  const fill = (id, list) => {
    const el = document.getElementById(id);
    if(!el || !Array.isArray(list)) return;
    el.innerHTML = '<option value="" disabled selected>請選擇</option>' +
      list.map(v=>`<option value="${v}">${v}</option>`).join('');
  };
  if (typeof window.config_getProductTypes==='function'){
    fill('product_type', window.config_getProductTypes());
  }
  if (typeof window.config_getFAStages==='function'){
    fill('fa_stage', window.config_getFAStages());
  }
  if (typeof window.config_getAxes==='function'){
    const axes = window.config_getAxes();
    for(let i=1;i<=6;i++) fill(`axis_${i}`, axes);
  }
  if (typeof window.config_getCategories==='function'){
    const cats = window.config_getCategories();
    for(let i=1;i<=6;i++) fill(`cat_${i}`, cats);
  }
}

// 監聽每列三欄：填齊→展開下一列；不齊→收回後續
function bindAxisAutoProgress(){
  for(let i=1;i<=6;i++){
    ['axis_','cat_','qty_'].forEach(p=>{
      const el = document.getElementById(p+i);
      if(!el) return;
      const ev = p==='qty_' ? 'input' : 'change';
      el.addEventListener(ev, ()=> onRowChange(i));
    });
  }
}

function onRowChange(i){
  const complete = isRowComplete(i);
  // 控制下一列
  if(complete && i<6){
    expandRow(i+1);
  }else if(!complete){
    // 變不完整：收回之後所有列並清空
    collapseFrom(i+1);
  }
}

function isRowComplete(i){
  const a = val(`axis_${i}`);
  const c = val(`cat_${i}`);
  const q = Number(val(`qty_${i}`));
  return !!a && !!c && q>0;
}

function expandRow(i){
  const el = document.querySelector(`.axis-block[data-idx="${i}"]`);
  if(el){ el.classList.remove('collapsed'); el.classList.add('expanded'); }
}
function collapseFrom(i){
  for(let j=i;j<=6;j++){
    const el = document.querySelector(`.axis-block[data-idx="${j}"]`);
    if(el){ el.classList.remove('expanded'); el.classList.add('collapsed'); }
    clearRow(j);
  }
}
function clearRow(i){
  ['axis_','cat_'].forEach(p=>{
    const s = document.getElementById(p+i);
    if(s) s.selectedIndex = 0;
  });
  const q = document.getElementById('qty_'+i);
  if(q) q.value = '';
}

// 報廢/續留互鎖 + 重工者啟用
function bindMutualLocks(){
  const scrapYes = document.getElementById('scrap_yes');
  const scrapKeep = document.getElementById('scrap_keep');
  const rework = document.getElementById('rework_confirm');
  const reworker = document.getElementById('reworker');

  if(scrapYes && scrapKeep){
    scrapYes.addEventListener('change', ()=>{ if(scrapYes.checked) scrapKeep.checked=false; });
    scrapKeep.addEventListener('change', ()=>{ if(scrapKeep.checked) scrapYes.checked=false; });
  }
  if(rework && reworker){
    const sync = ()=>{
      reworker.disabled = !rework.checked;
      if(!rework.checked) reworker.value='';
    };
    rework.addEventListener('change', sync);
    sync();
  }
}

function bindActions(){
  document.getElementById('btnPreview')?.addEventListener('click', ()=>{
    console.log(collectData());
    alert('預覽已輸出到 console');
  });
  document.getElementById('btnSubmit')?.addEventListener('click', ()=>{
    console.log(collectData());
    alert('已收集資料，依需求串接送出流程');
  });
}

function collectData(){
  const lines=[];
  for(let i=1;i<=6;i++){
    const a = val(`axis_${i}`), c = val(`cat_${i}`), q = Number(val(`qty_${i}`));
    if(!(a||c||q)) continue; // 全空略過
    lines.push({ axis:a, cat:c, qty:isFinite(q)?q:0 });
  }
  return {
    date: val('date_display'), shift: val('shift_display'),
    machine_id: val('machine_id'),
    product_type: val('product_type'), part_no: val('part_no'),
    fa_stage: val('fa_stage'), lot_no: val('lot_no'),
    lines,
    cutter_a: val('cutter_a'), inspector: val('inspector'),
    rework_confirm: document.getElementById('rework_confirm')?.checked || false,
    reworker: val('reworker'),
    scrap: document.getElementById('scrap_yes')?.checked ? 'SCRAP' :
           (document.getElementById('scrap_keep')?.checked ? 'KEEP' : ''),
    remark: val('remark'), reviewer: val('reviewer')
  };
}

function val(id){ return (document.getElementById(id)?.value || '').trim(); }
</script>
</body>
</html>